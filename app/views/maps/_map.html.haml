#map-container
  #map
  #sidebar.accordion
    - cache([:legend, active_map]) do
      .accordion-group
        .accordion-heading.accordion-toggle{ data: { toggle: 'collapse', parent: '#sidebar', target: '#legends'} }
          %h5
            %i.icon-white.icon-chevron-up
            Legend
        #legends.accordion-body.collapse.in
          .accordion-inner
            %ul.legend.nav
              - active_map.layers.each do |layer|
                - if layer.children.count > 0
                  - layer.children.each do |child|
                    - cache([:legend, active_map, child]) do
                      = render 'legend', layer: child
                      = render 'filter', layer: child
                - else
                  - cache([:legend, active_map, layer]) do
                    = render 'legend', layer: layer
                    = render 'filter', layer: layer
    .accordion-group
      .accordion-heading.accordion-toggle{ data: { toggle: 'collapse', parent: '#sidebar', target: '#help'} }
        %h5 
          %i.icon-white.icon-chevron-down
          Help
      #help.accordion-body.collapse
        .accordion-inner
          = render 'help'
#map-messages
#map-tools
  %p
    = link_to '#', :id => 'map-identify', :class => 'btn btn-small btn-primary', 'data-toggle'=>"button" do
      %i.icon-info-sign.icon-white
  
  %p
    .btn.btn-small.btn-success{ data: { toggle: 'collapse', parent: '#sidebar', target: '#help' } }
      %i.icon-question-sign.icon-white
#map-query.modal.hide.fade{role: 'dialog'}
  .modal-header
    %button.close{'data-dismiss' => 'modal'} &times;
    %h3 Query Results
  .modal-body
  .modal-footer
    %button.btn.pull-right{'data-dismiss' => 'modal'} Close
:javascript
  (new Map()).init('#{active_map.projection}');